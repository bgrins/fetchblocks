<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <!DOCTYPE html>
    <script id="worker" type="text/js-worker">
      importScripts("RESOLVED_SCRIPT");
      console.log(self);
      let { jsEval, fetchblocks, fetchblock } = self.fetchblocks;

      self.onmessage = async function(e) {
        console.log(e, e.data);

        if (e.data.type == "fetchblocks.run") {
          console.log("running");
          let resp = await fetchblocks.run(e.data.blocks, e.data.options);
          self.postMessage({
            resp
          })
        } else if (e.data.type == "jsEval") {
          self.postMessage(jsEval(e.data.message));
        } else {
        }
      };
    </script>
    <script>
      let resolvedScript = new URL(
        "../web/bundle-classic.js",
        document.location
      ).href;
      var blob = new Blob(
        [
          document
            .querySelector("#worker")
            .textContent.replace("RESOLVED_SCRIPT", resolvedScript),
        ],
        { type: "text/javascript" }
      );

      // Note: window.webkitURL.createObjectURL() in Chrome 10+.
      var worker = new Worker(window.URL.createObjectURL(blob));


      worker.onmessage = function (e) {
        console.log("Received: ", e.data);
      };
      worker.postMessage({
        type: "jsEval",
        message: "return 1+1",
      });
      worker.postMessage({
        type: "fetchblocks.run",
        blocks: [
          { resource: "https://x-colors.herokuapp.com/api/random" }
        ],
        options: {}
      });
    </script>
  </head>
</html>
